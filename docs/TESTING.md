# Testing the EMA-AI API

This document provides examples of how to test the EMA-AI API using curl commands.

## Prerequisites

- The EMA-AI service should be running (either locally or in Docker)
- Default URL is `http://localhost:8000` if running locally

## Health Check

To verify that the API is running:

```bash
curl -X GET http://localhost:8000/health
```

Expected response:

```json
{ "status": "ok", "version": "0.1.0" }
```

## Generate Adventure

To generate a new adventure based on a user prompt:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Je cherche une randonnée près de Bordeaux"}' \
  http://localhost:8000/api/generate
```

Expected response:

```json
{
  "title": "Randonnée dans les vignobles de Saint-Émilion",
  "description": "Une belle balade à travers les célèbres vignobles de Saint-Émilion, offrant des vues panoramiques sur la campagne bordelaise.",
  "location": "Saint-Émilion, Bordeaux",
  "tags": ["randonnée", "vignoble", "nature", "patrimoine"],
  "difficulty": "facile",
  "duration": 120,
  "distance": 8.5,
  "latitude": 44.8946,
  "longitude": -0.1556
}
```

Note: The actual response will vary as it's generated by the AI.

## Find Similar Adventures

To find adventures similar to a given adventure ID:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"adventure_id": 1}' \
  http://localhost:8000/api/search_similar
```

Expected response:

```json
{
  "similar_adventures": [
    {
      "id": 3,
      "title": "Balade dans les vignes de Pomerol",
      "similarity_score": 0.9
    },
    {
      "id": 7,
      "title": "Découverte du patrimoine viticole de Fronsac",
      "similarity_score": 0.8
    }
  ]
}
```

## Error Handling

The API provides consistent error responses with the following format:

```json
{
  "error": true,
  "code": "ERROR_CODE",
  "message": "Detailed error message",
  "path": "/api/endpoint"
}
```

### Common Error Codes

| Error Code                | HTTP Status | Description                              |
| ------------------------- | ----------- | ---------------------------------------- |
| `INVALID_PROMPT`          | 400         | The prompt is empty or invalid           |
| `ADVENTURE_NOT_FOUND`     | 404         | The requested adventure ID doesn't exist |
| `PROMPT_PROCESSING_ERROR` | 500         | Error processing the prompt              |
| `OPENAI_API_ERROR`        | 503         | Error communicating with OpenAI API      |

### Testing Error Responses

#### Invalid Prompt

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"prompt": ""}' \
  http://localhost:8000/api/generate
```

Expected response:

```json
{
  "error": true,
  "code": "INVALID_PROMPT",
  "message": "Le prompt doit contenir au moins 5 caractères",
  "path": "/api/generate"
}
```

#### Adventure Not Found

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"adventure_id": 999}' \
  http://localhost:8000/api/search_similar
```

Expected response:

```json
{
  "error": true,
  "code": "ADVENTURE_NOT_FOUND",
  "message": "Adventure with ID 999 not found",
  "path": "/api/search_similar"
}
```

## Using Helper Scripts

The project includes several helper scripts to make testing easier:

### Starting the Service

```bash
./scripts/start.sh
```

This script:

- Creates a virtual environment if needed
- Installs dependencies
- Creates a `.env` file if needed
- Starts the service

### Running Tests

```bash
./scripts/test.sh
```

This script:

- Creates a virtual environment if needed
- Installs dependencies
- Runs all tests

To run a specific test:

```bash
./scripts/test.sh tests/test_routes.py::test_health_check
```

### Testing Error Handling

```bash
# Install colorama first
pip install colorama

# Run the error testing script
python scripts/test_errors.py
```

This script tests various error scenarios and displays the responses in a formatted way.

## API Documentation

For interactive API documentation, visit:

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## Testing with Python

You can also test the API using Python with the `requests` library:

```python
import requests
import json

# Base URL
base_url = "http://localhost:8000"

# Health check
response = requests.get(f"{base_url}/health")
print(f"Health check: {response.status_code}")
print(response.json())

# Generate adventure
adventure_data = {"prompt": "Je cherche une randonnée près de Bordeaux"}
response = requests.post(f"{base_url}/api/generate", json=adventure_data)
print(f"Generate adventure: {response.status_code}")
print(json.dumps(response.json(), indent=2, ensure_ascii=False))

# Find similar adventures
similar_data = {"adventure_id": 1}
response = requests.post(f"{base_url}/api/search_similar", json=similar_data)
print(f"Find similar adventures: {response.status_code}")
print(json.dumps(response.json(), indent=2, ensure_ascii=False))
```

## Integration Testing

For testing the integration with the Rails API, see the [INTEGRATION.md](INTEGRATION.md) document.
